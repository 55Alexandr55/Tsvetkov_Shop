<!DOCTYPE html>
<html lang="uk" x-data="deliveryApp()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <title>Оформлення доставки</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <div class="container bg-white p-4 rounded shadow">
    <h3 class="mb-4">Оформлення доставки</h3>

    <!-- Выбор способа доставки -->
    <div class="mb-3">
      <label class="form-label">Спосіб доставки:</label>
      <select class="form-select" x-model="deliveryMethod">
        <option value="pickup">Самовивіз</option>
        <option value="np">Нова Пошта</option>
      </select>
    </div>

    <!-- Поля для всех -->
    <div class="mb-3">
      <label>Ім’я та прізвище:</label>
      <input class="form-control" x-model="form.full_name">
    </div>

    <div class="mb-3">
      <label>Телефон:</label>
      <input class="form-control" x-model="form.phone_number">
    </div>

    <div class="mb-3">
      <label>Email:</label>
      <input class="form-control" x-model="form.email" type="email">
    </div>

    <!-- Только если выбрана доставка Новой Почтой -->
    <template x-if="deliveryMethod === 'np'">
      <div>
        <div class="mb-3">
          <label>Місто:</label>
          <select class="form-select" x-model="selectedCity" @change="loadWarehouses">
            <option value="">Оберіть місто</option>
            <template x-for="city in cities" :key="city.Ref">
              <option :value="city.Ref" x-text="city.Description"></option>
            </template>
          </select>
        </div>

        <div class="mb-3">
          <label>Відділення:</label>
          <select class="form-select" x-model="form.warehouse">
            <option value="">Оберіть відділення</option>
            <template x-for="w in warehouses" :key="w.Ref">
              <option :value="w.Description" x-text="w.Description"></option>
            </template>
          </select>
        </div>
      </div>
    </template>

    <!-- Стоимость -->
    <div class="mb-3">
      <label>Загальна вартість:</label>
      <input class="form-control" type="number" x-model="form.total_price" readonly>
    </div>

    <button class="btn btn-success" @click="submitOrder">Оформити замовлення</button>

    <div class="alert alert-success mt-3" x-show="orderSuccess">
      Замовлення успішно створено!
    </div>
  </div>

<script>
function deliveryApp() {
  return {
    deliveryMethod: 'np',
    cities: [],
    warehouses: [],
    selectedCity: '',
    orderSuccess: false,
    form: {
      full_name: '',
      phone_number: '',
      email: '',
      warehouse: '',
      total_price: 1000  // Пример. В реальности подставляй из корзины
    },
    init() {
      fetch('/delivery/api/get_cities/')
        .then(res => res.json())
        .then(data => this.cities = data.data);
    },
    loadWarehouses() {
      fetch(`/delivery/api/get_warehouses/?cityRef=${this.selectedCity}`)
        .then(res => res.json())
        .then(data => this.warehouses = data.data);
    },
    submitOrder() {
      const payload = {
        ...this.form,
        city: this.selectedCity,
        delivery_method: this.deliveryMethod
      };
      fetch('/delivery/api/submit_order/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) this.orderSuccess = true;
      });
    }
  }
}
</script>
</body>
</html>
